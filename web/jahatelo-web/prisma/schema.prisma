// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum MotelStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AmenityType {
  MOTEL
  ROOM
  BOTH
}

enum PhotoKind {
  FACADE
  ROOM
  FOOD
  OTHER
}

enum UserRole {
  SUPERADMIN
  MOTEL_ADMIN
  USER
}

enum ProspectStatus {
  NEW
  CONTACTED
  IN_NEGOTIATION
  WON
  LOST
}

enum ProspectChannel {
  WEB
  APP
  MANUAL
}

enum PaymentType {
  DIRECT_DEBIT
  TRANSFER
  EXCHANGE
}

enum FinancialStatus {
  ACTIVE
  INACTIVE
  DISABLED
}

enum PaymentStatus {
  PAID
  PENDING
  FAILED
  REFUNDED
}

enum AnalyticsEventType {
  VIEW
  CLICK_PHONE
  CLICK_WHATSAPP
  CLICK_MAP
  CLICK_WEBSITE
  FAVORITE_ADD
  FAVORITE_REMOVE
}

enum AdPlacement {
  POPUP_HOME
  CAROUSEL
  SECTION_BANNER
  LIST_INLINE
}

enum AdStatus {
  ACTIVE
  PAUSED
  INACTIVE
}

enum AdEventType {
  VIEW
  CLICK
}

// ============================================
// MOTEL
// ============================================

model Motel {
  id               String          @id @default(cuid())
  name             String
  slug             String          @unique
  description      String?
  city             String
  neighborhood     String
  address          String
  country          String?
  mapUrl           String?
  latitude         Float?
  longitude        Float?
  phone            String?
  whatsapp         String?
  website          String?
  instagram        String?
  featuredPhoto    String?         // Foto principal/portada del motel
  status           MotelStatus     @default(PENDING)
  isActive         Boolean         @default(false)
  contactName      String?
  contactEmail     String?
  contactPhone     String?
  adminContactName   String?
  adminContactEmail  String?
  adminContactPhone  String?
  operationsContactName  String?
  operationsContactEmail String?
  operationsContactPhone String?
  plan             String?
  nextBillingAt    DateTime?
  isFeatured       Boolean         @default(false)
  ratingAvg        Float           @default(0)
  ratingCount      Int             @default(0)

  // Campos financieros
  billingDay       Int?            // Día del mes para cobro (1-31)
  paymentType      PaymentType?    // Tipo de cobro
  financialStatus  FinancialStatus @default(ACTIVE)
  billingCompanyName String?       // Razón Social
  billingTaxId     String?         // RUC
  isFinanciallyEnabled Boolean     @default(true) // Si está inhabilitado financieramente

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Relations
  rooms            RoomType[]
  menuCategories   MenuCategory[]
  photos           Photo[]
  motelAmenities   MotelAmenity[]
  reviews          Review[]
  schedules        Schedule[]
  paymentMethods   PaymentMethod[]
  socialLinks      SocialLink[]
  promos           Promo[]
  users            User[]         // Usuarios administradores del motel
  analytics        MotelAnalytics[] // Eventos de analytics
  paymentHistory   PaymentHistory[]
}

// ============================================
// PAYMENT HISTORY
// ============================================

model PaymentHistory {
  id            String        @id @default(cuid())
  motel         Motel         @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId       String
  amount        Int
  currency      String        @default("PYG")
  paidAt        DateTime      @default(now())
  status        PaymentStatus @default(PAID)
  paymentType   PaymentType?
  reference     String?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

// ============================================
// ROOM TYPE
// ============================================

model RoomType {
  id                String        @id @default(cuid())
  motel             Motel         @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId           String
  name              String
  slug              String?
  description       String?

  // Precios por tiempo
  price1h           Int?
  price1_5h         Int?
  price2h           Int?
  price3h           Int?
  price12h          Int?
  price24h          Int?
  priceNight        Int?
  customPrices      String?       // JSON para variantes futuras

  // Características
  maxPersons        Int?
  hasJacuzzi        Boolean       @default(false)
  hasPrivateGarage  Boolean       @default(false)
  isFeatured        Boolean       @default(false)
  isActive          Boolean       @default(true)

  // Legacy (mantener compatibilidad)
  basePrice         Int?
  priceLabel        String?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime?     @updatedAt

  // Relations
  amenities         RoomAmenity[]
  photos            Photo[]
  reviews           Review[]
  roomPhotos        RoomPhoto[]
}

// ============================================
// AMENITY
// ============================================

model Amenity {
  id              String          @id @default(cuid())
  name            String          @unique
  type            AmenityType?
  icon            String?
  description     String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime?       @updatedAt

  // Relations
  motelAmenities  MotelAmenity[]
  roomAmenities   RoomAmenity[]
}

// Motel Amenity (join table)
model MotelAmenity {
  id          String   @id @default(cuid())
  motel       Motel    @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId     String
  amenity     Amenity  @relation(fields: [amenityId], references: [id], onDelete: Cascade)
  amenityId   String

  @@unique([motelId, amenityId])
}

// Room Amenity (join table)
model RoomAmenity {
  id          String    @id @default(cuid())
  roomType    RoomType  @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)
  roomTypeId  String
  amenity     Amenity   @relation(fields: [amenityId], references: [id], onDelete: Cascade)
  amenityId   String

  @@unique([roomTypeId, amenityId])
}

// ============================================
// PHOTOS
// ============================================

model Photo {
  id          String     @id @default(cuid())
  url         String
  kind        PhotoKind  @default(OTHER)
  order       Int        @default(0)
  motel       Motel?     @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId     String?
  roomType    RoomType?  @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)
  roomTypeId  String?
  createdAt   DateTime?  @default(now())
  updatedAt   DateTime?  @updatedAt
}

// Room Photo (galería de fotos de habitación)
model RoomPhoto {
  id          String    @id @default(cuid())
  roomType    RoomType  @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)
  roomTypeId  String
  url         String
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================
// MENU
// ============================================

model MenuCategory {
  id          String      @id @default(cuid())
  motel       Motel       @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId     String
  name        String?
  slug        String?
  order       Int         @default(0)
  createdAt   DateTime?   @default(now())
  updatedAt   DateTime?   @updatedAt

  // Relations
  items       MenuItem[]

  // Legacy
  title       String?
  sortOrder   Int?
}

model MenuItem {
  id          String        @id @default(cuid())
  category    MenuCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId  String
  product     Product?      @relation(fields: [productId], references: [id])
  productId   String?
  name        String
  slug        String?
  description String?
  price       Int
  photoUrl    String?
  createdAt   DateTime?     @default(now())
  updatedAt   DateTime?     @updatedAt
}

// ============================================
// PRODUCTS (catálogo global)
// ============================================

model Product {
  id              String      @id @default(cuid())
  name            String
  slug            String      @unique
  description     String?
  defaultPrice    Int
  defaultPhotoUrl String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  menuItems       MenuItem[]
}

// ============================================
// REVIEWS / RATINGS
// ============================================

model Review {
  id          String     @id @default(cuid())
  motel       Motel?     @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId     String?
  roomType    RoomType?  @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)
  roomTypeId  String?
  user        User?      @relation(fields: [userId], references: [id])
  userId      String?
  score       Int        // 1-5
  comment     String?
  createdAt   DateTime   @default(now())
}

// ============================================
// USERS
// ============================================

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  passwordHash String
  name         String?
  birthDate    DateTime?
  role         UserRole   @default(USER)
  isActive     Boolean    @default(true)
  modulePermissions String[] @default([])

  // Relación con motel (para MOTEL_ADMIN)
  motel        Motel?     @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId      String?

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  reviews      Review[]
  favorites    Favorite[]
  auditLogs    AuditLog[]
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId     String?
  action     String
  entityType String
  entityId   String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
  @@index([entityType, createdAt])
}

// ============================================
// FAVORITES (a futuro)
// ============================================

model Favorite {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  motelId    String?
  roomTypeId String?
  createdAt  DateTime @default(now())

  @@unique([userId, motelId])
}

// ============================================
// SCHEDULES (horarios del motel)
// ============================================

model Schedule {
  id          String   @id @default(cuid())
  motel       Motel    @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId     String
  dayOfWeek   Int      // 0=Sunday, 1=Monday, etc.
  openTime    String?  // "09:00"
  closeTime   String?  // "22:00"
  is24Hours   Boolean  @default(false)
  isClosed    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// PAYMENT METHODS
// ============================================

model PaymentMethod {
  id          String   @id @default(cuid())
  motel       Motel    @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId     String
  method      String   // "CASH", "CARD", "TRANSFER", etc.
  createdAt   DateTime @default(now())
}

// ============================================
// SOCIAL LINKS
// ============================================

model SocialLink {
  id          String   @id @default(cuid())
  motel       Motel    @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId     String
  platform    String   // "FACEBOOK", "INSTAGRAM", "TIKTOK", "TWITTER", etc.
  url         String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// PROMOS (promociones especiales)
// ============================================

model Promo {
  id          String    @id @default(cuid())
  motel       Motel     @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId     String
  title       String
  description String?
  imageUrl    String?
  validFrom   DateTime?
  validUntil  DateTime?
  isActive    Boolean   @default(true)
  isGlobal    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================
// HOME BANNERS (carrusel de la home)
// ============================================

model HomeBanner {
  id          String    @id @default(cuid())
  title       String
  description String?
  imageUrl    String
  linkUrl     String?
  motelId     String?   // Opcional, si el banner es específico de un motel
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  validFrom   DateTime?
  validUntil  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================
// MOTEL PROSPECTS (leads de registro)
// ============================================

model MotelProspect {
  id            String          @id @default(cuid())
  contactName   String
  phone         String
  motelName     String
  status        ProspectStatus  @default(NEW)
  channel       ProspectChannel @default(WEB)
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

// ============================================
// MOTEL ANALYTICS (sistema de vistas y tracking)
// ============================================

model MotelAnalytics {
  id           String              @id @default(cuid())
  motel        Motel               @relation(fields: [motelId], references: [id], onDelete: Cascade)
  motelId      String
  eventType    AnalyticsEventType
  timestamp    DateTime            @default(now())

  // Metadatos del evento
  source       String?             // 'MAP', 'LIST', 'SEARCH', 'HOME', 'DETAIL'
  userCity     String?             // Ciudad del usuario (si está disponible)
  userCountry  String?             // País del usuario
  deviceType   String?             // 'MOBILE', 'WEB'

  // Campos opcionales para contexto adicional
  metadata     Json?               // Información adicional flexible

  @@index([motelId, timestamp])
  @@index([motelId, eventType])
  @@index([timestamp])
}

// ============================================
// ADVERTISEMENTS
// ============================================

model Advertisement {
  id            String       @id @default(cuid())
  title         String
  advertiser    String
  imageUrl      String
  largeImageUrl String?
  description   String?
  linkUrl       String?
  placement     AdPlacement
  status        AdStatus      @default(ACTIVE)
  priority      Int           @default(0)
  startDate     DateTime?
  endDate       DateTime?
  viewCount     Int           @default(0)
  clickCount    Int           @default(0)
  maxViews      Int?
  maxClicks     Int?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  analytics     AdAnalytics[]
}

model AdAnalytics {
  id               String       @id @default(cuid())
  advertisement    Advertisement @relation(fields: [advertisementId], references: [id], onDelete: Cascade)
  advertisementId  String
  eventType        AdEventType
  timestamp        DateTime     @default(now())
  deviceType       String?
  userCity         String?
  userCountry      String?
  source           String?

  @@index([advertisementId, timestamp])
  @@index([eventType, timestamp])
}
